name: CI
on:
  pull_request:
    branches: ["*"]
  push:
    branches: ["main"]
  schedule:
    - cron: '0 06 * * MON'
  workflow_dispatch:
concurrency:
  cancel-in-progress: true
  group: ${{ github.workflow }}-${{ github.ref }}
jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v5
      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v21
      - name: Build resume
        run: nix build .#resume
      - name: Build server
        run: nix build .
      - name: Check server health
        run: |
          ./result/bin/server &
          SERVER_PID=$!

          for i in {1..30}; do
            if curl -f http://localhost:8080/api/health 2>/dev/null; then
              echo "Health check passed after $i seconds"
              kill "$SERVER_PID" 2>/dev/null || true
              exit 0
            fi
            echo "Waiting for server... ($i/30)"
            sleep 1
          done
          echo "Health check failed after 30 seconds"
          kill "$SERVER_PID" 2>/dev/null || true
          exit 1
  check:
    name: Check
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v5
      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v21
      - name: Check flake
        run: nix flake check --impure
