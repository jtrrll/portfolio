name: Update Automated Pull Requests
on:
  push:
    branches: ["main"]
  workflow_dispatch:
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
jobs:
  update-pull-requests:
    name: Update automated pull requests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.PR_BOT_PERSONAL_ACCESS_TOKEN }}
      - name: Configure Git user
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      - name: Update pull requests with automated label
        env:
          GH_TOKEN: ${{ secrets.PR_BOT_PERSONAL_ACCESS_TOKEN }}
        run: |
          prs=$(gh pr list --label automated --json number,headRefName,baseRefName --jq '.[] | "\(.number)|\(.headRefName)|\(.baseRefName)"')

          if [ -z "$prs" ]; then
            echo "No automated pull requests to update"
            exit 0
          fi

          echo "$prs" | while IFS='|' read -r pr_number branch base_branch; do
            echo "Updating PR #$pr_number (merging $base_branch into $branch)"

            git fetch origin "$branch" "$base_branch" || {
              echo "Failed to fetch branches for PR #$pr_number. Skipping."
              continue
            }

            git checkout -B "$branch" "origin/$branch" || {
              echo "Failed to checkout $branch for PR #$pr_number. Skipping."
              continue
            }

            if git merge "origin/$base_branch" --no-edit; then
              echo "Successfully merged $base_branch into $branch"
              git push origin "$branch"
            else
              echo "Merge conflict detected for PR #$pr_number. Skipping."
              git merge --abort
            fi
          done
